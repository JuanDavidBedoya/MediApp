<div class="absolute top-0 left-0 h-full w-full overflow-hidden bg-blue-900 
  bg-linear-to-b from-blue-700 via-blue-400 to-blue-300">
</div>

<div class="relative flex min-h-screen items-center justify-center py-10 sm:py-20">

  <div class="mx-auto w-full max-w-3xl rounded-2xl bg-white p-6 sm:p-10 border-2 border-blue-500 relative shadow-2xl">
    <div class="mb-8 text-center">
      <h3 class="text-3xl font-bold text-blue-950">Agendar Nueva Cita M칠dica 游뽘</h3>
      <p class="text-blue-950 mt-2">
        Selecciona especialidad, fecha y hora. El doctor se asignar치 autom치ticamente.
      </p>
    </div>

    @if (submissionMessage) {
    <div class="mb-6 p-4 rounded-lg text-center font-medium"
      [ngClass]="{'bg-green-100 text-green-800': submissionMessage.type === 'success', 'bg-red-100 text-red-800': submissionMessage.type === 'error'}">
      {{ submissionMessage.text }}
    </div>
    }

    @if (isLoadingInitial) {
    <div class="text-center p-8 text-blue-700 font-semibold animate-pulse">
      Cargando informaci칩n del paciente...
    </div>
    } @else {
    
    <form #appointmentForm="ngForm" (ngSubmit)="scheduleAppointment()" class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <div class="space-y-4">
        
        <div>
          <label for="speciality" class="block text-sm font-medium text-blue-950 mb-1">Especialidad</label>
          <select id="speciality" name="speciality" required (change)="onSpecialityChange($event)"
            class="w-full rounded-lg border bg-blue-100 px-4 py-3 text-sm text-blue-950 
                   focus:border-blue-800 focus:bg-blue-200 focus:outline-none 
                   focus:scale-[1.01] transition-transform duration-300 ease-out"
            [ngModel]="selectedSpecialityName()" #speciality="ngModel">
            
            <option [ngValue]="undefined" disabled selected>
              @if (specialitiesResource.isLoading()) { Cargando Especialidades... } 
              @else { Selecciona una Especialidad }
            </option>
            @for (spec of specialitiesResource.value(); track spec.idSpeciality) {
            <option [value]="spec.name">{{ spec.name }}</option>
            }
          </select>
          @if (speciality.invalid && (speciality.dirty || speciality.touched)) {
            <div class="mt-1 text-xs text-red-600">
              <p>Debes seleccionar una especialidad.</p>
            </div>
          }
        </div>


      </div>

      <div class="space-y-4">
        
        <div>
          <label for="date" class="block text-sm font-medium text-blue-950 mb-1">Fecha de la Cita</label>
          <input type="date" id="date" name="date" required (change)="onDateChange($event)" [min]="minDate"
            class="w-full rounded-lg border bg-blue-100 px-4 py-3 text-sm text-blue-950
                   focus:border-blue-800 focus:bg-blue-200 focus:outline-none
                   focus:scale-[1.01] transition-transform duration-300 ease-out"
            [ngModel]="selectedDate()" #date="ngModel" [disabled]="!selectedSpecialityName()">
          @if (date.invalid && (date.dirty || date.touched)) {
            <div class="mt-1 text-xs text-red-600">
              <p>La fecha es obligatoria.</p>
            </div>
          }
        </div>

        <div>
          <label for="time" class="block text-sm font-medium text-blue-950 mb-1">Hora de la Cita</label>
          <select id="time" name="time" required (change)="onTimeChange($event)"
            class="w-full rounded-lg border bg-blue-100 px-4 py-3 text-sm text-blue-950
                   focus:border-blue-800 focus:bg-blue-200 focus:outline-none
                   focus:scale-[1.01] transition-transform duration-300 ease-out"
            [ngModel]="selectedTime()" #time="ngModel"
            [disabled]="!selectedDate()">

            <option [ngValue]="undefined" disabled selected>
              @if (!selectedDate()) { Selecciona una fecha primero }
              @else { Selecciona una hora }
            </option>

            @for (slot of availableTimeSlots; track slot) {
            <option [value]="slot">{{ slot }}</option>
            }
          </select>
          @if (time.invalid && (time.dirty || time.touched)) {
            <div class="mt-1 text-xs text-red-600">
              <p>Debes seleccionar una hora.</p>
            </div>
          }
        </div>
        
      </div>

      <div class="md:col-span-2">
        <label for="observations" class="block text-sm font-medium text-blue-950 mb-1">Motivo / Observaciones (Opcional)</label>
        <textarea id="observations" name="observations" [(ngModel)]="appointmentData.observations" rows="2"
          placeholder="Ej: Revisi칩n de chequeo anual, control de tensi칩n, etc."
          class="w-full rounded-lg border bg-blue-100 px-4 py-3 text-sm text-blue-950 
                 focus:border-blue-800 focus:bg-blue-200 focus:outline-none 
                 focus:scale-[1.01] transition-transform duration-300 ease-out"></textarea>
      </div>
      
      <div class="md:col-span-2 flex justify-center pt-4">
        <button type="submit" 
          [disabled]="appointmentForm.invalid || isSubmitting || !selectedTime()" 
          class="w-1/2 cursor-pointer justify-center rounded-lg p-3 font-semibold tracking-wide text-white
                bg-linear-to-br from-blue-800 via-blue-700 to-blue-800
                transition-all duration-300 ease-in-out
                hover:scale-[1.03] hover:contrast-125
                disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100 disabled:contrast-100">
          
          @if(isSubmitting) {
          <span class="animate-pulse">Agendando Cita...</span>
          } @else {
          <span>Confirmar Cita</span>
          }
        </button>
      </div>

    </form>
    }
  </div>
</div>