<div class="absolute top-0 left-0 h-full w-full overflow-hidden bg-blue-900 
  bg-linear-to-b from-blue-700 via-blue-400 to-blue-300">
</div>

<div class="relative flex min-h-screen items-center justify-center py-10 sm:py-20">

    <div class="mx-auto w-full max-w-4xl rounded-2xl bg-white p-6 sm:p-10 border-2 border-blue-500 relative shadow-2xl">
        <div class="mb-8 text-center">
            <h3 class="text-3xl font-bold text-blue-950">Generar Prescripción Médica (Fórmula) ✍️</h3>
            <p class="text-blue-950 mt-2">
                Paciente Cédula: <span class="font-semibold text-blue-700">{{ patientCedula || 'Cargando...' }}</span> |
                Cita ID: <span class="font-semibold text-blue-700">{{ appointmentId || 'Cargando...' }}</span> |
                Fórmula ID: <span class="font-semibold text-blue-700">{{ formulaId || 'Cargando...' }}</span>
            </p>
        </div>

        @if (submissionMessage) {
        <div class="mb-6 p-4 rounded-lg text-center font-medium"
            [ngClass]="{'bg-green-100 text-green-800': submissionMessage.type === 'success', 'bg-red-100 text-red-800': submissionMessage.type === 'error'}">
            {{ submissionMessage.text }}
        </div>
        }

        @if (isLoadingInitial) {
        <div class="text-center p-8 text-blue-700 font-semibold animate-pulse">
            Verificando permisos y datos de la cita...
        </div>
        } @else {

        <form #formulaForm="ngForm" (ngSubmit)="createFormula()" class="space-y-6">


            <h4 class="text-xl font-semibold text-blue-800 border-b pb-2">Medicamentos Prescritos</h4>


            <div class="space-y-4">
                @for (medication of medications; track $index; let i = $index) {
                <div class="p-4 border border-blue-200 rounded-lg bg-blue-50 grid grid-cols-1 md:grid-cols-4 gap-4">

                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-blue-950 mb-1">Medicamento {{ i + 1 }}*</label>
                        <select [name]="'medName-' + i" [(ngModel)]="medication.name" (change)="onMedicationChange($event, i)" required
                            class="w-full rounded-lg border bg-white px-3 py-2 text-sm text-blue-950
                     focus:border-blue-800 focus:outline-none transition duration-200">
                            <option value="" disabled selected>
                                @if (medicationsResource.isLoading()) { Cargando medicamentos... }
                                @else { Selecciona un medicamento }
                            </option>
                            @for (med of medicationsResource.value(); track med.id) {
                            <option [value]="med.name" [disabled]="isMedicationSelected(med.name, i)">{{ med.name }}</option>
                            }
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-blue-950 mb-1">Dosis*</label>
                        <input type="text" [name]="'medDosage-' + i" [(ngModel)]="medication.dosage" required
                            placeholder="Ej: 500mg" class="w-full rounded-lg border bg-white px-3 py-2 text-sm text-blue-950
                     focus:border-blue-800 focus:outline-none transition duration-200" />
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-blue-950 mb-1">Cantidad*</label>
                        <input type="number" [name]="'medQuantity-' + i" [(ngModel)]="medication.quantity" required min="1"
                            placeholder="Ej: 1, 2, 30" class="w-full rounded-lg border bg-white px-3 py-2 text-sm text-blue-950
                     focus:border-blue-800 focus:outline-none transition duration-200" />
                    </div>

                    <div class="flex items-end justify-end">
                        @if (medications.length > 1) {
                        <button type="button" (click)="eliminarMedicamento(i)"
                            class="p-2 text-red-500 hover:text-white hover:bg-red-500 rounded-lg transition duration-200">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        }
                    </div>

                </div>
                }
            </div>

            <button type="button" (click)="agregarMedicamento()" class="w-full rounded-lg border border-dashed border-blue-400 py-3 text-sm
                    font-medium text-blue-700 hover:bg-blue-50 mt-4">
                 + Añadir otro Medicamento
             </button>

            <div class="flex justify-center pt-6">
                <button type="submit"
                    [disabled]="formulaForm.invalid || isSubmitting || medications.length === 0" class="w-1/2 cursor-pointer justify-center rounded-lg p-3 font-semibold tracking-wide text-white
                bg-linear-to-br from-blue-800 via-blue-700 to-blue-800
                transition-all duration-300 ease-in-out
                hover:scale-[1.03] hover:contrast-125
                disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100 disabled:contrast-100">

                    @if(isSubmitting) {
                    <span class="animate-pulse">Creando Detalles de Prescripción...</span>
                    } @else {
                    <span>Crear Prescripción</span>
                    }
                </button>
            </div>

        </form>
        }
    </div>
</div>